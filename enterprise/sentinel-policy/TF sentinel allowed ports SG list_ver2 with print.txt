import "tfplan"

# whitelist of required L4 port list for ingress SG
required_ports = [
  22,
  8080,
]

require_ports_22_and_8080 = rule {
  any tfplan.resources.aws_security_group as _, instances {
    any instances as _, sg {
      all required_ports as port {
        any sg.applied.ingress as ingress {
          int(ingress.from_port) <= port and port <= int(ingress.to_port) 
        } or not print("No ingress rule had port", port)
      }
    }
  } and print("All required ports included in at least one ingress rule of at least one security group") 
}

main = rule {
  require_ports_22_and_8080
}